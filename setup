#!/bin/bash

user_name=$(whoami)
python_ver="3.10.14"
env_name="ansible-venv"
env_home="/home/$user_name/.pyenv/versions/$env_name"


curl -sSL https://raw.githubusercontent.com/hexqueller/prepare-ansible/master/pyenv | bash

if ! command -v pyenv &> /dev/null; then
  echo "Ошибка: pyenv не установлен. Попробуйте вручную: curl https://pyenv.run | bash"
  exit 1
fi

echo "Устанавливаем Python $python_ver с помощью pyenv"
pyenv install $python_ver
pyenv global $python_ver

echo "Создаем виртуальную среду"
pyenv virtualenv $python_ver $env_name
source $env_home/bin/activate

echo "Устанавливаем Ansible версии 2.12"
pip install ansible-core==2.12

echo "Устанавливаем зависимости"
pip install netaddr
pip install jinja2==3.0
pip install jmespath
pip install psycopg2
ansible-galaxy collection install community.general
ansible-galaxy collection install ansible.posix
ansible-galaxy collection install community.crypto
ansible-galaxy collection install community.postgresql
ansible-galaxy collection install ansible.utils

deactivate
echo "alias activate='source $env_home/bin/activate'" >> /home/$user_name/.bashrc
bash

if [ -f /home/$user_name/.zshrc ]; then
    echo "alias activate='source $env_home/bin/activate'" >> /home/$user_name/.zshrc
    zsh
elif [ -f /home/$user_name/.bashrc ]; then
    echo "alias activate='source $env_home/bin/activate'" >> /home/$user_name/.bashrc
    bash
else
    echo "Установка завершена, но не удалось найти .bashrc или .zshrc."
    echo "Добавьте Alias вручную: alias activate='source $env_home/bin/activate'"
    exit 0
fi

echo "Для работы с Ansible нужно активировать виртуальную среду! Это можно сделать командой: activate"